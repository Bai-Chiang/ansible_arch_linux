---
- block:
  - name: container config direcoty
    ansible.builtin.file:
      path: "{{ container_configs_dir }}/syncthing"
      state: directory
      owner: "{{ podman_user}}"
      group: "{{ podman_user }}"
      mode: '0700'

  - name: syncthing.service
    ansible.builtin.template:
      src: syncthing.service.j2
      dest: "/home/{{ podman_user }}/.config/systemd/user/syncthing.service"
      owner: "{{ podman_user}}"
      group: "{{ podman_user }}"
      mode: '0600'

  - name: systemctl --user daemon-reload
    ansible.builtin.systemd:
      daemon_reload: yes
      scope: user

  - name: systemctl --user enable syncthing.service
    ansible.builtin.systemd:
      name: syncthing
      enabled: yes
      scope: user

  #- name: Set UFW incoming roles for Syncthing WebUI
  #  community.general.ufw:
  #    route: yes
  #    rule: allow
  #    interface_in: "{{ static_nic }}"
  #    from_ip: "{{ item }}"
  #    to_ip: any
  #    proto: tcp
  #    port: 8384
  #    comment: "Allow Syncthing application WebUI from {{ item }}"
  #  loop: "{{ syncthing_allow_web_from }}"


  #- name: Set UFW incoming rules for Syncthing Listening port (UDP)
  #  community.general.ufw:
  #    route: yes
  #    rule: allow
  #    interface_in: "{{ static_nic }}"
  #    from_ip: "{{ item }}"
  #    to_ip: any
  #    proto: udp
  #    port: 22000
  #    comment: "Allow Syncthing listening port (TCP) from {{ item }}"
  #  loop: "{{ syncthing_allow_from }}"

  #- name: Set UFW incoming rules for Syncthing Protocol discovery
  #  community.general.ufw:
  #    route: yes
  #    rule: allow
  #    interface_in: "{{ static_nic }}"
  #    from_ip: "{{ item }}"
  #    to_ip: any
  #    proto: udp
  #    port: 21027
  #    comment: "Allow Syncthing Protocol discovery from {{ item }}"
  #  loop: "{{ syncthing_allow_from }}"

  become: yes
  become_user: "{{ podman_user }}"


- name: Set firewall rules for Syncthing Listening port (TCP)
  ansible.posix.firewalld:
    rich_rule: "{{ item }}"
    zone: "{{ firewalld_default_zone }}"
    permanent: yes
    immediate: yes
    state: enabled
  loop: "{{ syncthing_firewall }}"
  become: yes
